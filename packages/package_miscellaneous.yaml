## Package file for Home Assistant, used for alarms 
## Type: Home Assistant yaml file
## Date: 06-11-2019
## Author: R.Bisschops
##
## Changelog:
## V0.1.0:  First version
## V0.2.0:  Added bed time automation and scripts
## V0.2.1:  Changed bed time script
## V0.2.2:  Changed domoticz entertainment switch to Tradfri
## V0.3.0:  Moved input select toliet heating to package_toilet
## V0.3.1:  Added Tradfri testswitch
## V0.3.2:  Minor code clean
## V0.4.0:  Removed Tradfri testswitch
## V0.4.1:  Added condition recording mode in bedtime script 
## V0.5.0:  Added test services in script for toilet heating
## V0.5.1:  Added toilet heating settings to the the bed time script 
## V0.6.0:  Added template sensors for waste bin schedular 
## V0.7.0:  Added comments and some code cleaning
## V0.8.0:  Remover Domo Virtual heating from script
## V0.9.0:  Added leaving autoamtions and scripts
## V0.10.0: Added extended away script
## V0.11.0: Added hallway and porchlight on with timer to leaving script

###############################################################################
##  Homeassistant settings
###############################################################################
  

###############################################################################
##  Entities
###############################################################################
input_boolean:
  ## Holiday mode toggle switch, used for setting when on holiday 
  ## Several automations depend on this
  holiday_mode:
    name: Vakantie mode aan
    icon: mdi:toggle-switch
    initial: off
  ## Christmas mode toggle switch, used for setting when on ehem the holiday season is there 
  ## Several automations depend on this
  christmas_mode:
    name: Kerst periode
    icon: mdi:toggle-switch
    initial: off

binary_sensor:
  ## Definition of workdays with the workday sensor
  ## Used in several automations
  - platform: workday
    country: NL
    workdays: [mon, tue, wed, thu, fri, sat]
    excludes: [sun]

  ## Definition of the GFT (Bio) garbage bin
  ## Depends on google calendar for afval_kalender
  ## Used for sending "put the bin out" notifications
  - platform: template
    sensors:
      gft:
        friendly_name: GFT
        value_template: >-
          {% if is_state('calendar.afval_kalender', 'on') %}
            {% if state_attr('calendar.afval_kalender', 'message') == 'GFT' %}
              true
            {% elif state_attr('calendar.afval_kalender', 'message') == 'GFT + PMD' %}
              true
            {% else %}
              false
            {% endif %}
          {% else %}
            false
          {% endif %}
        entity_picture_template: >-
          {{ '/local/custom_icons/gft48_' ~ states.binary_sensor.gft.state ~ '.png' }}

  ## Definition of the PMD (Platic and metal) garbage bin
  ## Depends on google calendar for afval_kalender
  ## Used for sending "put the bin out" notifications
  - platform: template
    sensors:
      pmd:
        friendly_name: PMD
        value_template: >-
          {% if is_state('calendar.afval_kalender', 'on') %}
            {% if state_attr('calendar.afval_kalender', 'message') == 'PMD' %}
              true
            {% elif state_attr('calendar.afval_kalender', 'message') == 'GFT + PMD' %}
              true
            {% else %}
              false
            {% endif %}
          {% else %}
            false
          {% endif %}
        entity_picture_template: >-
          {{ '/local/custom_icons/pmd48_' ~ states.binary_sensor.pmd.state ~ '.png' }}

  ## Definition of the PMD and GFT (Plastic and metal and bio) garbage bins
  ## Depends on google calendar for afval_kalender
  ## Used for sending "put both bins out" notifications
  - platform: template
    sensors:
      gft_pmd:
        friendly_name: 'GFT en PMD'
        value_template: >-
          {% if is_state('calendar.afval_kalender', 'on') %}
            {% if state_attr('calendar.afval_kalender', 'message') == 'GFT + PMD' %}
              true
            {% else %}
              false
            {% endif %}
          {% else %}
            false
          {% endif %}

###############################################################################
##  Groups
###############################################################################


###############################################################################
##  Automations
###############################################################################
automation:
  ## Automation for runnning the bed time script 
  ## Called by Alexa via HA Bridge
  - alias: "Bed mode ingeschakeld"
    hide_entity: false
    initial_state: 'on'
    trigger:
      platform: state
      entity_id: 
      - binary_sensor.habridge_bed_time
      to: 'on'
    action:
      - service: script.turn_on
        entity_id: script.bedtime

  ## Automation for runnning the leaving script
  ## Called by Alexa via HA Bridge  
  - alias: "Leaving mode ingeschakeld"
    hide_entity: false
    initial_state: 'on'
    trigger:
      platform: state
      entity_id: 
      - binary_sensor.habridge_leaving
      to: 'on'
    action:
      - service: script.turn_on
        entity_id: script.leaving

  ## Added V0.10.0
  ## Automation for runnning the extended away script
  ## Called from binary sensor Extended Away
  - alias: "Extended away mode ingeschakeld"
    hide_entity: false
    initial_state: 'on'
    trigger:
      platform: state
      entity_id: 
      - binary_sensor.everybody_extended_away
      to: 'on'
    action:
      - service: script.turn_on
        entity_id: script.extended_away

  ## Automation to run when the garbage bins need to go out for collection
  - alias: "Vuilnisbak aan de straat"
    hide_entity: false
    initial_state: 'on'
    trigger:
      platform: state
      entity_id: 
      - binary_sensor.gft
      - binary_sensor.pmd
      - binary_sensor.gft_pmd
      to: 'on'
    action:
      - service: script.notify_telegram_ralph
        data_template:
          value1: 'Vandaag moet de '
          value2: '{{ trigger.to_state.attributes.friendly_name }}'
          value3: ' bak buiten worden gezet'
      - service: script.notify_telegram_anneke
        data_template:
          value1: 'Vandaag moet de '
          value2: '{{ trigger.to_state.attributes.friendly_name }}'
          value3: ' bak buiten worden gezet'

###############################################################################
##  Templates
###############################################################################


###############################################################################
##  Scripts
###############################################################################
script:
  ## Script running when we go to bed, sets the house in sleep mode
  bedtime:
    alias: Bedtime script
    sequence:
      ## Swtcih off the outdoor lighting
      - service: homeassistant.turn_off
        entity_id: input_boolean.domo_garden_light
      ## Swtcih off the christmastree
      - service: homeassistant.turn_off
        entity_id: input_boolean.domo_christmastree
        ## Switch off the living room lights
      - service: homeassistant.turn_off
        entity_id: input_boolean.livingroom_lights_status
      ## Change the climate settings for the toilet heating  
      - service: input_select.select_option
        data:
          entity_id: input_select.toilet_heating
          option: 'Spaarstand'
      - condition: state
        entity_id: input_boolean.recording_mode
        state: 'off'
      - service: homeassistant.turn_off
        entity_id: switch.tradfri_media_switch

  ## Added V0.9.0
  ## Script when leaving home, also called when everybody is away (from package_presence)
  leaving:
    alias: Leaving script
    sequence:
      ## Switch off the outdoor lighting
      - service: homeassistant.turn_off
        entity_id: input_boolean.domo_garden_light
      ## Switch off the living room lights
      - service: homeassistant.turn_off
        entity_id: input_boolean.livingroom_lights_status
      ## Change the climate settings for the toilet heating  
      - service: input_select.select_option
        data_template:
          entity_id: input_select.toilet_heating
          option: >
            {% if (states.input_select.toilet_heating.state != 'Uit') %}
              'Spaarstand'
            {% else %}
              'Uit'
            {% endif %}
      ## Turn off the media center, but only when recording mode is not set
      - condition: state
        entity_id: input_boolean.recording_mode
        state: 'off'
      - service: homeassistant.turn_off
        entity_id: switch.tradfri_media_switch
      ## Added V0.
      ## Turn on lighting, but only when dark
      - condition: sun
        after: sunset
      - condition: sun
        before: sunrise
      ## Switch on the outdoor lighting
      - service: homeassistant.turn_on
        entity_id: input_boolean.domo_porch_light
      - service: timer.start
        data_template:
          entity_id: timer.porchlight
          duration: '00:{{ states.input_text.timer_minutes_porch_short.state | int }}:00'
      - service: homeassistant.turn_on
        entity_id: input_boolean.domo_hallway_light
      - service: timer.start
        data_template:
          entity_id: timer.hallwaylight
          duration: '00:{{ states.input_text.timer_minutes_hallwaylight_long.state | int }}:00'

  ## Added V0.10.0
  ## Script everybody extended away
  extended_away:
    alias: Iedereen langere tijd weg script
    sequence:
      - service: input_select.select_option
        data:
          entity_id: input_select.toilet_heating
          option: 'Uit'
      - service: homeassistant.turn_on
        entity_id: input_boolean.holiday_mode

  ## Added V0.9.0
  coming_home:
    alias: Coming home script
    sequence:
      ## Change the climate settings for the toilet heating  
      - service: input_select.select_option
        data_template:
          entity_id: input_select.toilet_heating
          option: >
            {% if (states.input_select.toilet_heating.state != 'Uit') %}
              'Verwarmen'
            {% else %}
              'Uit'
            {% endif %}
      ## Turn on lighting, but only when dark
      - condition: sun
        after: sunset
      - condition: sun
        before: sunrise
      ## Switch on the outdoor lighting
      - service: homeassistant.turn_on
        entity_id: input_boolean.domo_garden_light
      ## Switch on the living room lights
      - service: homeassistant.turn_on
        entity_id: input_boolean.livingroom_lights_status
      ## Turn on the media center, but only when recording mode is not set
      - condition: time
        after: '19:30:00:00'
      - service: homeassistant.turn_on
        entity_id: switch.tradfri_media_switch

###############################################################################
##  Timers
###############################################################################

